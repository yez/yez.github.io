<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
    <meta name="description" content="Understanding the ActiveRecord API is an important step towards proficiency in the Ruby on Rails framework. These five features should help new and seasoned Ruby on Rails developers expand their tool set.">
  

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Five More Active Record Features You Should Be Using
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="http://jakeyesbeck.com/public/css/compiled.css">
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://jakeyesbeck.com/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="http://jakeyesbeck.com/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      <h2 class='h1'>
        <a href="http://jakeyesbeck.com">
          A Year of Commits
        </a>
      </h2>
      <p class="lead">Jake Yesbeck's blog consisting of technical solutions, opinions about life, and updates on "A Year of Commits".
</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="http://jakeyesbeck.com">Home</a>
      <a class="sidebar-nav-item" href="/archives">Archives</a>
      <a class="sidebar-nav-item" href="http://jakeyesbeck.com/assets/files/yesbeckResume2018.pdf">Resume</a>
      <a class="sidebar-nav-item" href="/about">About</a>
      <a class="sidebar-nav-item" href="https://github.com/yez">GitHub</a>
      <a class="sidebar-nav-item" href="https://twitter.com/jakeyesbeck">Twitter</a>
      <a class="sidebar-nav-item" href="/atom.xml">Feed</a>
    </nav>

    <p class='copyright'>&copy; Jake Yesbeck 2020. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Five More Active Record Features You Should Be Using</h1>
  <span class="post-date">27 Mar 2016</span>
  
  <span class='share-container'><ul class="share-buttons">
  <li>
    <a href="https://www.facebook.com/sharer/sharer.php?u=http://jakeyesbeck.com/2016/03/27/five-more-active-record-features-you-should-be-using/&t=Five More Active Record Features You Should Be Using" title="Share on Facebook" target="_blank">
      <img src="http://jakeyesbeck.com/assets/images/facebook.svg">
    </a>
  </li>
  <li>
    <a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Fjakeyesbeck.com&text=Five More Active Record Features You Should Be Using%20http://jakeyesbeck.com/2016/03/27/five-more-active-record-features-you-should-be-using/&via=jakeyesbeck" target="_blank" title="Tweet">
      <img src="http://jakeyesbeck.com/assets/images/twitter.svg">
    </a>
  </li>
  <li>
    <a href="https://plus.google.com/share?url=http://jakeyesbeck.com/2016/03/27/five-more-active-record-features-you-should-be-using/" target="_blank" title="Share on Google+">
      <img src="http://jakeyesbeck.com/assets/images/google_plus.svg">
    </a>
  </li>

  <li>
    <a href="https://news.ycombinator.com/submitlink?u=http://jakeyesbeck.com/2016/03/27/five-more-active-record-features-you-should-be-using/&t=Five More Active Record Features You Should Be Using" target="_blank" title="Share on Hacker News">
      <img src="http://jakeyesbeck.com/assets/images/ycomb.svg">
    </a>
  </li>

  <li>
    <a href="https://getpocket.com/save?url=http://jakeyesbeck.com/2016/03/27/five-more-active-record-features-you-should-be-using/&title=Five More Active Record Features You Should Be Using" target="_blank" title="Add to Pocket">
      <img src="http://jakeyesbeck.com/assets/images/pocket.svg">
    </a>
  </li>
  <li>
    <a href="http://www.reddit.com/submit?url=http://jakeyesbeck.com/2016/03/27/five-more-active-record-features-you-should-be-using/&title=Five More Active Record Features You Should Be Using" target="_blank" title="Submit to Reddit">
      <img src="http://jakeyesbeck.com/assets/images/reddit.svg">
    </a>
  </li>
</ul>
</span>
  <p>In a <a href="http://jakeyesbeck.com/2015/11/15/five-active-record-features-you-should-be-using/">previous post</a>, I illustrated a few helpful <code class="highlighter-rouge">ActiveRecord</code> features. The entire API of <code class="highlighter-rouge">ActiveRecord</code> cannot possibly be contained within a single or even a handful of digestible posts; but, here are at least five more pieces of that massive API that some might find useful.</p>

<p>Just like before, the example application used to demonstrate these features will be an imaginary Ruby on Rails application: <em>“booksandreviews.com”</em>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:reviews</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Review</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="pluck">1. <code class="highlighter-rouge">pluck</code></h2>

<p>Introduced in Ruby on Rails 4.0, the <code class="highlighter-rouge">pluck</code> method helps keep memory allocation to a minimum when returning results from <code class="highlighter-rouge">ActiveRecord</code> queries. A great use case for the <code class="highlighter-rouge">pluck</code> method is when a database table backing an <code class="highlighter-rouge">ActiveRecord</code> object has a very large number of columns. In this situation, returning an object’s full dataset can be cause unnecessary memory allocation and potentially expensive deserialization (in the case of custom or JSON serialized columns).</p>

<p>To get a list of <code class="highlighter-rouge">book_ids</code> from the <code class="highlighter-rouge">'fantasy'</code> genre, the <code class="highlighter-rouge">pluck</code> method is a simple to use:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">genre: </span><span class="s1">'fantasy'</span><span class="p">).</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
<span class="c1"># SELECT "books"."id" FROM "books" WHERE "books"."genre" = 'fantasy'</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">]</span>
</code></pre>
</div>

<p>An important thing to recognize about the <code class="highlighter-rouge">pluck</code> method is its return value. Unlike its cousin, <code class="highlighter-rouge">select</code>, the <code class="highlighter-rouge">pluck</code> method does not return an <code class="highlighter-rouge">ActiveRecord</code> instance.</p>

<p>Multiple column names may be passed to <code class="highlighter-rouge">pluck</code> and the values of these columns will be returned in a nested <code class="highlighter-rouge">Array</code>. The returned <code class="highlighter-rouge">Array</code> will maintain the order of columns to how they were requested:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">genre: </span><span class="s1">'fantasy'</span><span class="p">).</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:title</span><span class="p">)</span>
<span class="c1"># SELECT "books"."id", "books"."title" FROM "books" WHERE "books"."genre" = 'fantasy'</span>
<span class="o">=&gt;</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'A Title'</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'Another One'</span><span class="p">]]</span>
</code></pre>
</div>

<p>While possible, it might not always be the best idea to request multiple columns in a single <code class="highlighter-rouge">pluck</code> call. Too many columns can produce an unruly result and nullify the performance gain <code class="highlighter-rouge">pluck</code> provided in the first place.</p>

<h2 id="transaction">2. <code class="highlighter-rouge">transaction</code></h2>

<p>An important aspect of relational databases is its atomic behaviour. When creating <code class="highlighter-rouge">ActiveRecord</code> objects, maintaining this aspect is possible through the use of the <code class="highlighter-rouge">transaction</code> method.</p>

<p>For instance, if an exception occurs during the update of all of a <code class="highlighter-rouge">Book's</code> <code class="highlighter-rouge">Reviews</code>, a <code class="highlighter-rouge">transaction</code> can help mitigate harmful side-effects:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">book</span><span class="p">.</span><span class="nf">reviews</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">review</span><span class="o">|</span>
  <span class="n">review</span><span class="p">.</span><span class="nf">meaningful_update!</span>
<span class="k">end</span>
</code></pre>
</div>

<p>If the <code class="highlighter-rouge">meaningful_update!</code> method throws an exception, all reviews before the erroring review will update appropriately and all after will not. If this method has a compounding side-effect (like incrementing a field), iterating through all reviews again would be harmful.</p>

<p>With a <code class="highlighter-rouge">transaction</code>, this problem does not exist:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">reviews</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">review</span><span class="o">|</span>
    <span class="n">review</span><span class="p">.</span><span class="nf">meaningful_update!</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>After adding the <code class="highlighter-rouge">transaction</code>, this new code will revert all changes contained within the <code class="highlighter-rouge">transaction</code> if an exception is raised. It is equivalent to updating all records in a single query.</p>

<h2 id="aftercommit">3. <code class="highlighter-rouge">after_commit</code></h2>

<p>Love them or hate them, callbacks in Ruby on Rails are a viable option to solve many problems. <code class="highlighter-rouge">ActiveRecord</code> callbacks are initiated at different times depending on the operation a model is about to undergo.</p>

<p>A fairly common use case for callbacks in Ruby on Rails revolves around what to do after a model is persisted. A model can be persisted by either <code class="highlighter-rouge">save</code>, <code class="highlighter-rouge">create</code> or <code class="highlighter-rouge">update</code>. Since the concept of “saving” is the common denominator for all these methods, it would be reasonable to use the <code class="highlighter-rouge">after_save</code> to trigger logic that should follow one of these persistence operations.</p>

<p>To add a new <code class="highlighter-rouge">Book</code> to a queue for a <code class="highlighter-rouge">Review</code> after it is saved:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">after_save</span> <span class="ss">:enqueue_for_review</span>

  <span class="k">def</span> <span class="nf">enqueue_for_review</span>
    <span class="no">ReviewQueue</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">book_id: </span><span class="nb">self</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="no">Logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Added </span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2"> to ReviewQueue"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>We can assume that the <code class="highlighter-rouge">ReviewQueue</code> is a key/value storage (Redis or something similar) backed object whose purpose is to place new <code class="highlighter-rouge">Books</code> into a queue for critics to review. The <code class="highlighter-rouge">Logger</code> class simply outputs text to <code class="highlighter-rouge">stdout</code>.</p>

<p>When everything goes well, the callback works beautifully:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">Book</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
  <span class="ss">title: </span><span class="s1">'A New Book'</span><span class="p">,</span>
  <span class="ss">author_id: </span><span class="mi">3</span><span class="p">,</span>
  <span class="ss">content: </span><span class="s1">'Blah blah...'</span>
<span class="p">)</span>
<span class="c1">#=&gt; Added 4 to ReviewQueue</span>
<span class="c1">#=&gt; &lt;Book id: 4, title: 'A New Book' ..&gt;</span>

<span class="no">ReviewQueue</span><span class="p">.</span><span class="nf">size</span>
<span class="c1">#=&gt; 1</span>
</code></pre>
</div>

<p>However, if this code was wrapped in a <code class="highlighter-rouge">transaction</code>, and that <code class="highlighter-rouge">transaction</code> fails, the <code class="highlighter-rouge">Book</code> will not persist but the element on in the Redis-backed <code class="highlighter-rouge">ReviewQueue</code> remains.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="no">Book</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
    <span class="ss">title: </span><span class="s1">'A New Book'</span><span class="p">,</span>
    <span class="ss">author_id: </span><span class="mi">3</span><span class="p">,</span>
    <span class="ss">content: </span><span class="s1">'Blah blah...'</span>
  <span class="p">)</span>

  <span class="k">raise</span> <span class="no">StandardError</span><span class="p">,</span> <span class="s1">'Something Happened'</span>
<span class="k">end</span>

<span class="c1">#=&gt; Added 4 to ReviewQueue</span>
<span class="c1">#=&gt; Error 'Something Happened'</span>

<span class="no">ReviewQueue</span><span class="p">.</span><span class="nf">size</span>
<span class="c1">#=&gt; 1</span>
</code></pre>
</div>

<p>This code has now generated an element on the <code class="highlighter-rouge">ReviewQueue</code> for a non-existent <code class="highlighter-rouge">Book</code>; however, if the <code class="highlighter-rouge">after_commit</code> callback is used, this problem will fade away.</p>

<p>Replacing <code class="highlighter-rouge">after_save</code> with <code class="highlighter-rouge">after_commit</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">after_commit</span> <span class="ss">:enqueue_for_review</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The same code results a much more desirable outcome:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="no">Book</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
    <span class="ss">title: </span><span class="s1">'A New Book'</span><span class="p">,</span>
    <span class="ss">author_id: </span><span class="mi">3</span><span class="p">,</span>
    <span class="ss">content: </span><span class="s1">'Blah blah...'</span>
  <span class="p">)</span>

  <span class="k">raise</span> <span class="no">StandardError</span><span class="p">,</span> <span class="s1">'Something Happened'</span>
<span class="k">end</span>

<span class="c1">#=&gt; Error 'Something Happened'</span>

<span class="no">ReviewQueue</span><span class="p">.</span><span class="nf">size</span>
<span class="c1">#=&gt; 0</span>
</code></pre>
</div>

<p>Awesome, the <code class="highlighter-rouge">after_commit</code> callback is only triggered after the record is persisted to the database, exactly what we wanted. Ruby on Rails provides <a href="http://guides.rubyonrails.org/active_record_callbacks.html">many more callback hooks</a> besides <code class="highlighter-rouge">after_commit</code>.</p>

<h2 id="touch">4. <code class="highlighter-rouge">touch</code></h2>

<p>To update a single timestamp column on an <code class="highlighter-rouge">ActiveRecord</code> object, <code class="highlighter-rouge">touch</code> is a great option. This method can accept the column name which should be updated in addition to an object’s <code class="highlighter-rouge">:updated_at</code> (if present).</p>

<p>A great time to utilize the <code class="highlighter-rouge">touch</code> method is when tracking when a record was last viewed. The good people at <em>“booksandreviews.com”</em> need to be sure their <code class="highlighter-rouge">Reviews</code> are being seen and want to know which <code class="highlighter-rouge">Reviews</code> have not been viewed in a while.</p>

<p>If the <code class="highlighter-rouge">Review</code> table has a <code class="highlighter-rouge">last_viewed_at</code> column which is of type <code class="highlighter-rouge">timestamp</code>, <code class="highlighter-rouge">touch</code> can easily update this column in a controller action:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ReviewsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@review</span> <span class="o">=</span> <span class="no">Review</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@review</span><span class="p">.</span><span class="nf">touch</span><span class="p">(</span><span class="ss">:last_viewed_at</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>A request which calls this controller action will result in the query:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">UPDATE</span> <span class="nv">"reviews"</span>
<span class="k">SET</span> <span class="nv">"updated_at"</span> <span class="o">=</span> <span class="s1">'2016-03-28 00:43:43.616367'</span><span class="p">,</span>
<span class="nv">"last_viewed_at"</span> <span class="o">=</span> <span class="s1">'2016-03-28 00:43:43.616367'</span>
<span class="k">WHERE</span> <span class="nv">"reviews"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre>
</div>

<p>Unlike setting other attributes, the <code class="highlighter-rouge">touch</code> method invokes an update query right away.</p>

<h2 id="changes">5. <code class="highlighter-rouge">changes</code></h2>

<p><code class="highlighter-rouge">ActiveRecord</code> keeps a sizable amount of information about an object while it undergoes updates. A hash, accessible via the <code class="highlighter-rouge">changes</code> method, acts a central location for these updates. Additionally, <code class="highlighter-rouge">ActiveRecord</code> exposes a number of per-attribute helper methods to give even more visibility.</p>

<p>Each key in the <code class="highlighter-rouge">changes</code> hash maps to a record’s attribute. The value of each key is an Array with two elements: what the attribute value used to be, and what it is now:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">review</span> <span class="o">=</span> <span class="no">Review</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">review</span><span class="p">.</span><span class="nf">book_id</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">review</span><span class="p">.</span><span class="nf">changes</span>
<span class="c1"># =&gt; {"book_id"=&gt;[4, 5]}</span>
</code></pre>
</div>

<h3 id="a-changed">a. <code class="highlighter-rouge">changed?</code></h3>

<p>A simple boolean method <code class="highlighter-rouge">changed?</code> is available to determine if anything on the object is different since its retrieval.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">review</span> <span class="o">=</span> <span class="no">Review</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">review</span><span class="p">.</span><span class="nf">book_id</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">review</span><span class="p">.</span><span class="nf">changed?</span>
<span class="c1"># =&gt; true</span>
</code></pre>
</div>

<p>However, if the same value is set on a model, regardless of the value’s <code class="highlighter-rouge">object_id</code>, <code class="highlighter-rouge">changed?</code> returns <code class="highlighter-rouge">false</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">book</span><span class="p">.</span><span class="nf">title</span>
<span class="c1"># =&gt; 'A Book'</span>
<span class="n">book</span><span class="p">.</span><span class="nf">title</span><span class="p">.</span><span class="nf">object_id</span>
<span class="c1"># =&gt; 2158279020</span>
<span class="n">book</span><span class="p">.</span><span class="nf">title</span> <span class="o">=</span> <span class="s1">'A Book'</span>
<span class="n">book</span><span class="p">.</span><span class="nf">changed?</span>
<span class="c1"># =&gt; false</span>
<span class="n">book</span><span class="p">.</span><span class="nf">title</span><span class="p">.</span><span class="nf">object_id</span>
<span class="c1"># =&gt; 2158274600</span>
</code></pre>
</div>

<p>Two “different” strings were set to <code class="highlighter-rouge">book.title</code> but since they resolve to the same characters, the object is not <code class="highlighter-rouge">changed?</code>.</p>

<p>When using PostgreSQL, the <code class="highlighter-rouge">changed?</code> method can save unnecessary <code class="highlighter-rouge">begin</code> and <code class="highlighter-rouge">commit</code> transaction calls for objects that have no changes:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BooksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">sanitized_params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@book</span><span class="p">.</span><span class="nf">assign_attributes</span><span class="p">(</span><span class="n">sanitized_params</span><span class="p">)</span>
    <span class="vi">@book</span><span class="p">.</span><span class="nf">save!</span> <span class="k">if</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">changed?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h3 id="b-attributewas">b. <code class="highlighter-rouge">&lt;attribute&gt;_was</code></h3>

<p>Accessing the same <code class="highlighter-rouge">changes</code> hash as the <code class="highlighter-rouge">changed?</code> method, <code class="highlighter-rouge">&lt;attribute&gt;_was</code> returns the value of an attribute before it was reassigned:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">review</span> <span class="o">=</span> <span class="no">Review</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">review</span><span class="p">.</span><span class="nf">status</span> <span class="o">=</span> <span class="s1">'Approved'</span>
<span class="n">review</span><span class="p">.</span><span class="nf">status_was</span>
<span class="c1"># =&gt; 'Pending'</span>
</code></pre>
</div>

<p>If a <code class="highlighter-rouge">Review's</code> status moving from <code class="highlighter-rouge">"Pending"</code> to <code class="highlighter-rouge">"Approved"</code> should remove it from an approval queue, the <code class="highlighter-rouge">status_was</code> method can be utilized in a callback:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Review</span>
  <span class="n">before_save</span> <span class="ss">:maybe_remove_from_review_queue</span>

  <span class="k">def</span> <span class="nf">maybe_remove_from_review_queue</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">'Approved'</span> <span class="o">&amp;&amp;</span>
        <span class="n">status_was</span> <span class="o">==</span> <span class="s1">'Pending'</span>
      <span class="no">ReviewQueue</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>To verify the result, we can check that the <code class="highlighter-rouge">ReviewQueue</code> decrements its internal count of reviews pending review:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">ReviewQueue</span><span class="p">.</span><span class="nf">size</span>
<span class="c1">#=&gt; 1</span>
<span class="n">review</span> <span class="o">=</span> <span class="no">Review</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">review</span><span class="p">.</span><span class="nf">status</span>
<span class="c1"># =&gt; 'Pending'</span>
<span class="n">review</span><span class="p">.</span><span class="nf">status</span> <span class="o">=</span> <span class="s1">'Approved'</span>
<span class="n">review</span><span class="p">.</span><span class="nf">save!</span>
<span class="c1"># =&gt; true</span>
<span class="no">ReviewQueue</span><span class="p">.</span><span class="nf">size</span>
<span class="c1">#=&gt; 0</span>
</code></pre>
</div>

<p><em>Note: Additional considerations might need to be made since the <code class="highlighter-rouge">save</code> is not guaranteed to persist like described above in the <code class="highlighter-rouge">after_commit</code> example.</em></p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/11/15/five-active-record-features-you-should-be-using/">
            Five Active Record Features You Should Be Using
            <small>15 Nov 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/02/07/how-to-remove-a-column-with-zero-downtime-in-ruby-on-rails/">
            How to Remove a Column with Zero Downtime in Ruby on Rails
            <small>07 Feb 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2017/07/12/a-few-rspec-helpful-hints/">
            A Few RSpec Helpful Hints
            <small>12 Jul 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62292380-1', 'auto');
  ga('require', 'linkid');
  ga('send', 'pageview');

  window.setTimeout(function() {
    ga('send', 'event', '10 seconds', 'passed')
  }, 30 * 1000);
</script>

  </body>
  <script src="//load.sumome.com/" data-sumo-site-id="c1ac0d77564d88e7bccc5e57a3839303fe48b17353cf42e4a295539de43b653b" async="async"></script>
  <script src="https://use.fontawesome.com/b3103405a3.js"></script>
</html>
